{% extends 'base.html' %}
{% block title %}Advanced search{% endblock %}
{% block content %}
<div class="row">
    <div class="col-sm-12">
        <h1>
            Advanced search
        </h1>
        <form>
            <div class="form-group">
                <input type="text" class="form-control" name="term" placeholder="Search term" {% if term %}value="{{term}}"{% endif %}>
            </div>
            <div class="form-group">
                <label class="checkbox-inline" for="table_name">
                    <input type="checkbox" name="table_name" value="candidates"> Candidates
                </label>
                <label class="checkbox-inline" for="table_name">
                    <input type="checkbox" name="table_name" value="committees"> Committees
                </label>
                <label class="checkbox-inline" for="table_name">
                    <input type="checkbox" name="table_name" value="officers"> Committee officers
                </label>
                <label class="checkbox-inline" for="table_name">
                    <input type="checkbox" name="table_name" value="receipts"> Donors
                </label>
                <label class="checkbox-inline" for="table_name">
                    <input type="checkbox" name="table_name" value="expenditures"> Expenditures
                </label>
                <label class="checkbox-inline" for="table_name">
                    <input type="checkbox" name="table_name" value="investments"> Investments
                </label>
            </div>
            <div class="form-group">
                <div class="row">
                    <div class="col-sm-6">
                        <label for="election_type">Election type</label>
                        <select class="form-control" name="election_type">
                            <option value="">------</option>
                            <option value="General Election">General Election</option>
                            <option value="General Primary">General Primary</option>
                            <option value="Consolidated Election">Consolidated Election</option>
                            <option value="Consolidated Primary">Consolidated Primary</option>
                            <option value="Special Primary">Special Primary</option>
                        </select>
                    </div>
                    <div class="col-sm-6">
                        <label for="election_year">Election year</label>
                        <select class="form-control" name="election_year">
                            <option value="">------</option>
                            {% for year in range(2018, 1979, -1)%}
                                {% if year == now.year %}
                                    <option value="{{ year }}" selected=true>{{ year }}</option>
                                {% else %}
                                    <option value="{{ year }}">{{ year }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <div class="row">
                    <div class="col-sm-3">
                        <label for="contribution_operator">Operator</label>
                        <select class="form-control" name="contribution_operator">
                            <option value="">------</option>
                            <option value="greater_than">Greater than</option>
                            <option value="less_than">Less than</option>
                            <option value="equal_to">Equal to</option>
                        </select>
                    </div>
                    <div class="col-sm-9">
                        <label for="contribution_amount">Contribution amount</label>
                        <input type="text" class="form-control" name="contribution_amount" placeholder="">
                    </div>
                </div>
            </div>
            <button type="submit" class="btn btn-default">Submit</button>
        </form>
    </div>
</div>

<hr />

<div class="row">
    <div class="col-sm-12">
        <div class="panel-group" id="search-results" role="tab-list" aria-multiselectable=true></div>
    </div>
</div>

{% endblock %}
{% block extra_javascript %}
    <script src="{{ url_for('static', filename='js/spin.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/jquery.spin.js') }}"></script>
    <script src="{{ url_for('static', filename='js/ejs_production.js') }}"></script>
    <script type="text/EJS" id="committeesResult">
        <div class="panel panel-default">
            <div class="panel-heading" role="tab" id="committees">
                <h1 class="panel-title">
                    <a role="button"
                       data-toggle="collapse"
                       data-parent="search-results"
                       href="#collapseCommittees"
                       aria-expanded="false"
                       aria-controls="collapseCommittees">

                       Commiteee results

                    </a>
                </h1>
            </div>
            <div id="collapseCommittees"
                 class="panel-collapse collapse in"
                 role="tabpanel"
                 aria-labelledby="committees">

                <div class="panel-body">
                    <% $.each(results, function(i, result){ %>
                        <h3><a href="/committees/<%= result.id %>"><%= result.name %></a></h3>
                    <% }) %>
                </div>

            </div>
        </div>
    </script>
    <script type="text/EJS" id="candidatesResult">
        <div class="panel panel-default">
            <div class="panel-heading" role="tab" id="candidates">
                <h1 class="panel-title">
                    <a role="button"
                       data-toggle="collapse"
                       data-parent="search-results"
                       href="#collapseCandidates"
                       aria-expanded="false"
                       aria-controls="collapseCandidates">

                       Candidate results

                    </a>
                </h1>
            </div>
            <div id="collapseCandidates"
                 class="panel-collapse collapse in"
                 role="tabpanel"
                 aria-labelledby="candidates">

                <div class="panel-body">
                    <% $.each(results, function(i, result){ %>
                        <h3><a href="/candidates/<%= result.id %>"><%= result.first_name %> <%= result.last_name %></a></h3>
                    <% }) %>
                </div>

            </div>
        </div>
    </script>
    <script type="text/EJS" id="receiptsResult">
        <div class="panel panel-default">
            <div class="panel-heading" role="tab" id="receipts">
                <h1 class="panel-title">
                    <a role="button"
                       data-toggle="collapse"
                       data-parent="search-results"
                       href="#collapseReceipts"
                       aria-expanded="false"
                       aria-controls="collapseReceipts">

                       Donation results

                    </a>
                </h1>
            </div>
            <div id="collapseReceipts"
                 class="panel-collapse collapse in"
                 role="tabpanel"
                 aria-labelledby="receipts">

                <div class="panel-body">
                    <% $.each(results, function(i, result){ %>
                        <h3><a href="/contributions/<%= result.id %>"><%= result.first_name %> <%= result.last_name %></a></h3>
                    <% }) %>
                </div>

            </div>
        </div>
    </script>
    <script type="text/EJS" id="officersResult">
        <div class="panel panel-default">
            <div class="panel-heading" role="tab" id="officers">
                <h1 class="panel-title">
                    <a role="button"
                       data-toggle="collapse"
                       data-parent="search-results"
                       href="#collapseOfficers"
                       aria-expanded="false"
                       aria-controls="collapseOfficers">

                       Committee officer results

                    </a>
                </h1>
            </div>
            <div id="collapseOfficers"
                 class="panel-collapse collapse in"
                 role="tabpanel"
                 aria-labelledby="officers">

                <div class="panel-body">
                    <% $.each(results, function(i, result){ %>
                        <h3><a href="/committees/<%= result.committee_id %>"><%= result.first_name %> <%= result.last_name %></a></h3>
                    <% }) %>
                </div>

            </div>
        </div>
    </script>
    <script type="text/EJS" id="expendituresResult">
        <div class="panel panel-default">
            <div class="panel-heading" role="tab" id="expenditures">
                <h1 class="panel-title">
                    <a role="button"
                       data-toggle="collapse"
                       data-parent="search-results"
                       href="#collapseExpenditures"
                       aria-expanded="false"
                       aria-controls="collapseExpenditures">

                       Expenditures results

                    </a>
                </h1>
            </div>
            <div id="collapseExpenditures"
                 class="panel-collapse collapse in"
                 role="tabpanel"
                 aria-labelledby="expenditures">

                <div class="panel-body">
                    <% $.each(results, function(i, result){ %>
                        <h3><a href="/expenditures/<%= result.committee_id %>"><%= result.first_name %> <%= result.last_name %></a></h3>
                    <% }) %>
                </div>

            </div>
        </div>
    </script>
    <script type="text/EJS" id="investmentsResult">
        <div class="panel panel-default">
            <div class="panel-heading" role="tab" id="investments">
                <h1 class="panel-title">
                    <a role="button"
                       data-toggle="collapse"
                       data-parent="search-results"
                       href="#collapseInvestments"
                       aria-expanded="false"
                       aria-controls="collapseInvestments">

                       Investments results

                    </a>
                </h1>
            </div>
            <div id="collapseInvestments"
                 class="panel-collapse collapse in"
                 role="tabpanel"
                 aria-labelledby="investments">

                <div class="panel-body">
                    <% $.each(results, function(i, result){ %>
                        <h3><a href="/committees/<%= result.committee_id %>"><%= result.first_name %> <%= result.last_name %></a></h3>
                    <% }) %>
                </div>

            </div>
        </div>
    </script>
<script type="text/javascript">
    $(document).ready(function(){
        $('form').on('submit', function(e){
            $('#search-results').empty();
            $('#search-results').spin('large')
            e.preventDefault();
            var params = $(this).serialize();
            do_query(params);
        });
        if ($('input[name="term"]').val() != ''){
            var params = 'term=' + $('input[name="term"]').val();
            do_query(params);
        }
    })
    function do_query(params){
        $.when($.getJSON("{{ url_for('api.advanced_search') }}" + '?' + params)).then(
            function(resp){
                $('#search-results').spin(false);
                $.each(resp.objects, function(table_name, results){
                    var template = new EJS({'text': $('#' + table_name + 'Result').html()});
                    $('#search-results').append(template.render({'results': results}));
                })
            }
        )
    }
</script>
{% endblock %}
