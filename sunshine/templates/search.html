{% extends 'base.html' %}
{% block title %}Advanced search{% endblock %}
{% block content %}
<div class="row">
    <div class="col-sm-12">
        <h1>
            Search
        </h1>
        <form>
            <div class="form-group">
                <input type="text" class="form-control" name="term" placeholder="Search term" {% if term %}value="{{term}}"{% endif %}>
            </div>
            <div class="form-group">
                <label class="checkbox-inline">
                    <input type="checkbox" name="table_name" value="candidates"> Candidates
                </label>
                <label class="checkbox-inline">
                    <input type="checkbox" name="table_name" value="committees"> Committees
                </label>
                <label class="checkbox-inline">
                    <input type="checkbox" name="table_name" value="officers"> Committee officers
                </label>
                <label class="checkbox-inline">
                    <input type="checkbox" name="table_name" value="receipts"> Donors
                </label>
                <label class="checkbox-inline">
                    <input type="checkbox" name="table_name" value="expenditures"> Expenditures
                </label>
                <label class="checkbox-inline">
                    <input type="checkbox" name="table_name" value="investments"> Investments
                </label>
            </div>
            <div class="form-group">
                <div class="row">
                    <div class="col-sm-6">
                        <label for="election_type">Election type</label>
                        <select class="form-control" name="election_type">
                            <option value="">------</option>
                            <option value="General Election">General Election</option>
                            <option value="General Primary">General Primary</option>
                            <option value="Consolidated Election">Consolidated Election</option>
                            <option value="Consolidated Primary">Consolidated Primary</option>
                            <option value="Special Primary">Special Primary</option>
                        </select>
                    </div>
                    <div class="col-sm-6">
                        <label for="election_year">Election year</label>
                        <select class="form-control" name="election_year">
                            <option value="">------</option>
                            {% for year in range(2018, 1979, -1)%}
                                {% if year == now.year %}
                                    <option value="{{ year }}" selected=true>{{ year }}</option>
                                {% else %}
                                    <option value="{{ year }}">{{ year }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <div class="row">
                    <div class="col-sm-3">
                        <label for="contribution_operator">Operator</label>
                        <select class="form-control" name="contribution_operator">
                            <option value="">------</option>
                            <option value="greater_than">Greater than</option>
                            <option value="less_than">Less than</option>
                            <option value="equal_to">Equal to</option>
                        </select>
                    </div>
                    <div class="col-sm-9">
                        <label for="contribution_amount">Contribution amount</label>
                        <input type="text" class="form-control" name="contribution_amount" placeholder="">
                    </div>
                </div>
            </div>
            <button type="submit" class="btn btn-default"><i class='fa fa-search'></i> Search</button>
        </form>
    </div>
</div>

<hr />

<div class="row">
    <div class="col-sm-12">
        <div id="search-results"></div>
    </div>
</div>

{% endblock %}
{% block extra_javascript %}
    <script src="{{ url_for('static', filename='js/spin.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/jquery.spin.js') }}"></script>
    <script src="{{ url_for('static', filename='js/ejs_production.js') }}"></script>
    <script src="{{ url_for('static', filename='js/accounting.min.js') }}"></script>
    <script type="text/EJS" id="committeesResult">
        <div class="search-result">
            <p><strong><%= results.name %></strong> (<%= results.table_name %>)</p>
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th></th>
                        <th>Committee type</th>
                        <th>Party</th>
                        <th>Purpose</th>
                        <th>Active</th>
                    </tr>
                </thead>
                <tbody>
                <% $.each(results.records, function(i, record){ %>
                    <tr>
                        <td>
                            <a href="/committees/<%= record.id %>/">
                                <%= record.name %>
                            </a>
                        </td>
                        <td>
                            <%= record.type %>
                        </td>
                        <td>
                            <%= record.party %>
                        </td>
                        <td>
                            <%= record.purpose %>
                        </td>
                        <td>
                            <%= record.active %>
                        </td>
                    </tr>
                <% }) %>
                </tbody>
            </table>
        </div>
    </script>
    <script type="text/EJS" id="candidatesResult">
        <div class="search-result">
            <p><strong><%= results.name %></strong> (<%= results.table_name %>)</p>
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th></th>
                        <th>Party</th>
                        <th>Office held</th>
                    </tr>
                </thead>
                <tbody>
                <% $.each(results.records, function(i, record){ %>
                    <tr>
                        <td>
                            <a href="/candidates/<%= record.id %>/">
                                <%= record.first_name %> <% record.last_name %>
                            </a>
                        </td>
                        <td>
                            <%= record.party %>
                        </td>
                        <td>
                            <%= record.office %>
                        </td>
                    </tr>
                <% }) %>
                </tbody>
            </table>
        </div>
    </script>
    <script type="text/EJS" id="receiptsResult">
        <div class="search-result">
            <p><strong><%= results.name %></strong> (<%= results.table_name %>)</p>
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Committee name</th>
                        <th>Amount</th>
                        <th>Recieved date</th>
                    </tr>
                </thead>
                <tbody>
                <% $.each(results.records, function(i, record){ %>
                    <tr>
                        <td>
                            <a href="/committees/<%= record.committee_id %>/">
                                <%= record.committee_name %>
                            </a>
                        </td>
                        <td>
                            <%= accounting.formatMoney(record.amount) %>
                        </td>
                        <td>
                            <%= record.received_date %>
                        </td>
                    </tr>
                <% }) %>
                </tbody>
            </table>
        </div>
    </script>
    <script type="text/EJS" id="officersResult">
        <div class="search-result">
            <p><strong><%= results.name %></strong> (<%= results.table_name %>)</p>
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Committee name</th>
                        <th>Title</th>
                        <th>Current officer</th>
                        <th>Resign date</th>
                    </tr>
                </thead>
                <tbody>
                <% $.each(results.records, function(i, record){ %>
                    <tr>
                        <td>
                            <a href="/committees/<%= record.committee_id %>/">
                                <%= record.committee_name %>
                            </a>
                        </td>
                        <td>
                            <%= record.title %>
                        </td>
                        <td>
                            <%= record.current %>
                        </td>
                        <td>
                            <%= record.resign_date %>
                        </td>
                    </tr>
                <% }) %>
                </tbody>
            </table>
        </div>
    </script>
    <script type="text/EJS" id="expendituresResult">
        <div class="search-result">
            <p><strong><%= results.name %></strong> (<%= results.table_name %>)</p>
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Committee name</th>
                        <th>Amount</th>
                        <th>Expended date</th>
                    </tr>
                </thead>
                <tbody>
                <% $.each(results.records, function(i, record){ %>
                    <tr>
                        <td>
                            <a href="/committees/<%= record.committee_id %>/">
                                <%= record.committee_name %>
                            </a>
                        </td>
                        <td>
                            <a href="/expenditures/<%= record.id %>/">
                                <%= accounting.formatMoney(record.amount) %>
                            </a>
                        </td>
                        <td>
                            <%= record.expended_date %>
                        </td>
                    </tr>
                <% }) %>
                </tbody>
            </table>
        </div>
    </script>
    <script type="text/EJS" id="investmentsResult">
        <div class="search-result">
            <p><strong><%= results.name %></strong> (<%= results.table_name %>)</p>
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Committee name</th>
                        <th>Current value</th>
                        <th>Liquid value</th>
                    </tr>
                </thead>
                <tbody>
                <% $.each(results.records, function(i, record){ %>
                    <tr>
                        <td>
                            <a href="/committees/<%= record.committee_id %>/">
                                <%= record.committee_name %>
                            </a>
                        </td>
                        <td>
                            <%= record.current_value %>
                        </td>
                        <td>
                            <%= record.liquid_value %>
                        </td>
                    </tr>
                <% }) %>
                </tbody>
            </table>
        </div>
    </script>
<script type="text/javascript">
    $(document).ready(function(){
        $('form').on('submit', function(e){
            $('#search-results').empty();
            $('#search-results').spin('large')
            e.preventDefault();
            var params = $(this).serialize();
            do_query(params);
        });
        // Need to figure this out so that it doesn't trigger all the time.
        //
        // if ($('input[name="term"]').val() != ''){
        //     var params = 'term=' + $('input[name="term"]').val();
        //     do_query(params);
        // }
    })
    function do_query(params){
        $.when($.getJSON("{{ url_for('api.advanced_search') }}" + '?' + params)).then(
            function(resp){
                $('#search-results').spin(false);
                $.each(resp.objects, function(i, results){
                    var template_guts = $('#' + results.table_name + 'Result').html()
                    var template = new EJS({'text': template_guts});
                    $('#search-results').append(template.render({'results': results}));
                })
            }
        )
    }
</script>
{% endblock %}
