{% extends 'base.html' %}
{% block title %}Search{% endblock %}
{% block content %}
<div class="row">
    <div class="col-sm-12">
        <h1>
            <i class='fa fa-search'></i> Search
        </h1>
        <form>
            <div class="input-group input-group-lg">
                <input type="text" class="form-control" placeholder="Search for candidates, committees and donors in Illinois" name="term" {% if term %}value="{{term}}"{% endif %}>
                <span class="input-group-btn">
                    <button class="btn btn-default" type="submit"><i class='fa fa-search'></i> Search</button>
                </span>
            </div>
            <div class="form-group" id='filter-results'>
                <br />
                <span>Filter by result type:</span>
                <label data-title='Candidates' data-content='Any person who seeks nomination for election, election to, or retention in public office'>
                    <input type="checkbox" name="table_name" value="candidates" checked='checked'> Candidates
                </label>
                <label data-title='Committees' data-content='Includes committees for political candidates, political parties, political action committees (PACs), and ballot initiatives'>
                    <input type="checkbox" name="table_name" value="committees" checked='checked'> Committees
                </label>
                <label data-title='Committee officers' data-content='Chairmen and treasurerers for political committees'>
                    <input type="checkbox" name="table_name" value="officers" checked='checked'> Committee officers
                </label>
                <label data-title='Donors' data-content='Any person or organization who has given to a political committee'>
                    <input type="checkbox" name="table_name" value="receipts" checked='checked'> Donors
                </label>
                <label data-title='Expenditures' data-content='Any payment, distribution, purchase, loan, advance, deposit, gift of money or anything of value, or any transfer of funds between political committees, made to support or oppose a candidate or proposition'>
                    <input type="checkbox" name="table_name" value="expenditures" checked='checked'> Expenditures
                </label>
                <label data-title='Investments' data-content='Funds invested by political committees'>
                    <input type="checkbox" name="table_name" value="investments" checked='checked'> Investments
                </label>
            </div>
        </form>
    </div>
</div>

<hr />

<div class="row">
    <div class="col-sm-12">
        <div id="search-results"></div>
    </div>
</div>

{% endblock %}
{% block extra_javascript %}
    <script src="{{ url_for('static', filename='js/spin.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/jquery.spin.js') }}"></script>
    <script src="{{ url_for('static', filename='js/ejs_production.js') }}"></script>
    <script src="{{ url_for('static', filename='js/accounting.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/moment.min.js') }}"></script>
    <script type="text/EJS" id="committeesResult">
        <div class="search-result">
            <p><strong><%= results.name %></strong> (<%= results.table_name %>)</p>
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th></th>
                        <th>Committee type</th>
                        <th>Party</th>
                        <th>Purpose</th>
                        <th>Active</th>
                    </tr>
                </thead>
                <tbody>
                <% $.each(results.records, function(i, record){ %>
                    <tr>
                        <td>
                            <a href="/committees/<%= record.id %>/">
                                <%= record.name %>
                            </a>
                        </td>
                        <td>
                            <%= record.type %>
                        </td>
                        <td>
                            <%= record.party %>
                        </td>
                        <td>
                            <%= record.purpose %>
                        </td>
                        <td>
                            <%= record.active %>
                        </td>
                    </tr>
                <% }) %>
                </tbody>
            </table>
        </div>
    </script>
    <script type="text/EJS" id="candidatesResult">
        <div class="search-result">
            <p><strong><%= results.name %></strong> (<%= results.table_name %>)</p>
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th></th>
                        <th>Party</th>
                        <th>Office held</th>
                    </tr>
                </thead>
                <tbody>
                <% $.each(results.records, function(i, record){ %>
                    <tr>
                        <td>
                            <a href="/candidates/<%= record.id %>/">
                                <%= record.first_name %> <% record.last_name %>
                            </a>
                        </td>
                        <td>
                            <%= record.party %>
                        </td>
                        <td>
                            <%= record.office %>
                        </td>
                    </tr>
                <% }) %>
                </tbody>
            </table>
        </div>
    </script>
    <script type="text/EJS" id="receiptsResult">
        <div class="search-result">
            <p><strong><%= results.name %></strong> (<%= results.table_name %>)</p>
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Committee name</th>
                        <th>Amount</th>
                        <th>Recieved date</th>
                    </tr>
                </thead>
                <tbody>
                <% $.each(results.records, function(i, record){ %>
                    <tr>
                        <td>
                            <a href="/committees/<%= record.committee_id %>/">
                                <%= record.committee_name %>
                            </a>
                        </td>
                        <td>
                            <%= accounting.formatMoney(record.amount) %>
                        </td>
                        <td>
                            <%= moment(record.received_date).format('MMM D, YYYY') %>
                        </td>
                    </tr>
                <% }) %>
                </tbody>
            </table>
        </div>
    </script>
    <script type="text/EJS" id="officersResult">
        <div class="search-result">
            <p><strong><%= results.name %></strong> (<%= results.table_name %>)</p>
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Committee name</th>
                        <th>Title</th>
                        <th>Current officer</th>
                        <th>Resign date</th>
                    </tr>
                </thead>
                <tbody>
                <% $.each(results.records, function(i, record){ %>
                    <tr>
                        <td>
                            <a href="/committees/<%= record.committee_id %>/">
                                <%= record.committee_name %>
                            </a>
                        </td>
                        <td>
                            <%= record.title %>
                        </td>
                        <td>
                            <%= record.current %>
                        </td>
                        <td>
                            <%= moment(record.resign_date).format('MMM D, YYYY') %>
                        </td>
                    </tr>
                <% }) %>
                </tbody>
            </table>
        </div>
    </script>
    <script type="text/EJS" id="expendituresResult">
        <div class="search-result">
            <p><strong><%= results.name %></strong> (<%= results.table_name %>)</p>
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Committee name</th>
                        <th>Amount</th>
                        <th>Expended date</th>
                    </tr>
                </thead>
                <tbody>
                <% $.each(results.records, function(i, record){ %>
                    <tr>
                        <td>
                            <a href="/committees/<%= record.committee_id %>/">
                                <%= record.committee_name %>
                            </a>
                        </td>
                        <td>
                            <a href="/expenditures/<%= record.id %>/">
                                <%= accounting.formatMoney(record.amount) %>
                            </a>
                        </td>
                        <td>
                            <%= moment(record.expended_date).format('MMM D, YYYY') %>
                        </td>
                    </tr>
                <% }) %>
                </tbody>
            </table>
        </div>
    </script>
    <script type="text/EJS" id="investmentsResult">
        <div class="search-result">
            <p><strong><%= results.name %></strong> (<%= results.table_name %>)</p>
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Committee name</th>
                        <th>Current value</th>
                        <th>Liquid value</th>
                    </tr>
                </thead>
                <tbody>
                <% $.each(results.records, function(i, record){ %>
                    <tr>
                        <td>
                            <a href="/committees/<%= record.committee_id %>/">
                                <%= record.committee_name %>
                            </a>
                        </td>
                        <td>
                            <%= record.current_value %>
                        </td>
                        <td>
                            <%= record.liquid_value %>
                        </td>
                    </tr>
                <% }) %>
                </tbody>
            </table>
        </div>
    </script>
<script type="text/javascript">
    $(document).ready(function(){

        $('#filter-results label').popover({trigger: "hover", placement: "bottom"});

        $('form').on('submit', function(e){
            $('#search-results').empty();
            $('#search-results').spin('large')
            e.preventDefault();
            var params = $(this).serialize();
            do_query(params);
        });

        {% if term != None %}
            $('#search-results').spin('large');
            do_query('term={{term}}');
        {% endif %}
    })
    function do_query(params){
        $.when($.getJSON("{{ url_for('api.advanced_search') }}" + '?' + params)).then(
            function(resp){
                $('#search-results').spin(false);
                $.each(resp.objects, function(i, results){
                    var template_guts = $('#' + results.table_name + 'Result').html()
                    var template = new EJS({'text': template_guts});
                    $('#search-results').append(template.render({'results': results}));
                })
            }
        )
    }
</script>
{% endblock %}
